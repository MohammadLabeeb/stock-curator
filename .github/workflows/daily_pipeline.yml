name: Daily Stock Curation Pipeline

on:
  schedule:
    # Run at 8:00 AM IST = 2:30 AM UTC (same day)
    # IST is UTC+5:30, so 8:00 AM IST = 2:30 AM UTC
    # Run Monday-Friday only (1-5 in cron, where 0=Sunday, 6=Saturday)
    - cron: '30 2 * * 1-5'

  workflow_dispatch:  # Allow manual trigger for testing

env:
  PYTHON_VERSION: '3.10'

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit results back to repo
      issues: write    # Required to create issues on failure

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv pip install --system -r requirements.txt

      - name: Check if already ran today
        id: check_run
        run: |
          TODAY=$(TZ='Asia/Kolkata' date +%Y-%m-%d)
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          if [ -f "data/daily_results/${TODAY}_predictions.json" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Already ran for $TODAY"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Running pipeline for $TODAY"
          fi

      - name: Run daily pipeline
        if: steps.check_run.outputs.skip == 'false'
        env:
          WORLD_NEWS_API_KEY: ${{ secrets.WORLD_NEWS_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UPSTOX_ACCESS_TOKEN: ${{ secrets.UPSTOX_ACCESS_TOKEN }}
          DAGSHUB_USER: ${{ secrets.DAGSHUB_USER }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          python -m src.pipeline.daily_pipeline

      - name: Commit and push results
        if: steps.check_run.outputs.skip == 'false'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add data/daily_results/
          TODAY="${{ steps.check_run.outputs.today }}"
          git commit -m "üìä Daily predictions for $TODAY" || echo "No changes to commit"
          git push

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ö†Ô∏è Pipeline Failed - ${today}`,
              body: `The daily stock curation pipeline failed.\n\n**Run Details:**\n- Workflow: ${context.workflow}\n- Run ID: ${context.runId}\n- [View Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n**Next Steps:**\n1. Check the workflow logs\n2. Verify API keys are set correctly\n3. Check API rate limits\n4. Re-run manually if needed`
            });

      - name: Upload artifacts on success
        if: success() && steps.check_run.outputs.skip == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: daily-predictions-${{ steps.check_run.outputs.today }}
          path: data/daily_results/${{ steps.check_run.outputs.today }}_predictions.json
          retention-days: 90
